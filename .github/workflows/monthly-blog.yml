name: Generate Monthly AI Blog Post - Blog Updates Only

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: '0 9 1 * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      topic:
        description: 'Custom blog topic (optional - will use default Canadian business focus)'
        required: false
        type: string
      output:
        description: 'Output directory'
        required: false
        default: 'blog/posts'
        type: choice
        options:
        - blog/posts
        - staging

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Generate monthly AI insights blog post
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            python scripts/generate-blog.py --topic "${{ github.event.inputs.topic }}" --output ${{ github.event.inputs.output || 'blog/posts' }}
          else
            python scripts/generate-blog.py --output ${{ github.event.inputs.output || 'blog/posts' }}
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "AI Blog Generator"
      
      - name: Check for changes
        id: git-check
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          MONTH_YEAR=$(date +"%B %Y")
          git commit -m "📝 Generate AI Insights Blog Post - $MONTH_YEAR
          
          🤖 Monthly AI developments analysis for Canadian businesses
          📊 Key technology launches and business impact assessment  
          🎯 Strategic recommendations for digital leaders
          🔄 Blog index automatically updated with new post
          
          ⚠️  BLOG PAGES ONLY - Homepage NOT modified
          
          Generated by: ${{ github.workflow }} #${{ github.run_number }}
          Template: Canadian business focus with citation cleaning
          Scope: Blog directory updates only"
          
          git push
      
      - name: Create success summary
        if: steps.git-check.outputs.changes == 'true'
        run: |
          echo "## 🎉 AI Insights Blog Post Generated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**📅 Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**🎯 Focus:** Canadian Business Impact Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**📂 Output:** ${{ github.event.inputs.output || 'blog/posts' }} directory" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            echo "**🔖 Custom Topic:** ${{ github.event.inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Content Structure:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Monthly overview of AI developments" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Key technology launches from major companies" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Canadian business impact analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 5 strategic recommendations for leaders" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Clean formatting (Perplexity citations removed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔄 Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 New monthly blog post created" >> $GITHUB_STEP_SUMMARY
          echo "- 🔗 \`blog/posts/latest.html\` updated" >> $GITHUB_STEP_SUMMARY
          echo "- 📋 \`blog/index.html\` updated with new post listing" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️  **Homepage NOT modified** (as requested)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Visit your blog at \`/blog/\` to see the new post" >> $GITHUB_STEP_SUMMARY
          echo "- Review the generated content for accuracy" >> $GITHUB_STEP_SUMMARY
          echo "- Share the insights on LinkedIn/social media" >> $GITHUB_STEP_SUMMARY
          echo "- Your homepage will continue showing your static content" >> $GITHUB_STEP_SUMMARY
      
      - name: Create no-changes summary
        if: steps.git-check.outputs.changes == 'false'
        run: |
          echo "## ℹ️ No Blog Changes Made" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The blog generation script completed but no files were changed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔍 Possible Reasons:" >> $GITHUB_STEP_SUMMARY
          echo "- 🔑 **API Issues**: Perplexity API key problems or rate limiting" >> $GITHUB_STEP_SUMMARY
          echo "- 🌐 **Network**: Connectivity issues during generation" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 **Duplicate**: Generated content identical to existing post" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️  **Error**: Script encountered an exception" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🛠️ Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs above for specific errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify PERPLEXITY_API_KEY secret is properly configured" >> $GITHUB_STEP_SUMMARY
          echo "3. Try manual workflow dispatch to test" >> $GITHUB_STEP_SUMMARY
          echo "4. Check Perplexity API service status" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: generate-blog
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## ❌ Blog Generation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**📅 Failed At:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**🔧 Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**🔢 Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚨 Action Required:" >> $GITHUB_STEP_SUMMARY
          echo "The monthly AI insights blog post was not generated successfully." >> $GITHUB_STEP_SUMMARY
          echo "Please review the workflow logs and address any issues." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔧 Common Fixes:" >> $GITHUB_STEP_SUMMARY
          echo "- Verify PERPLEXITY_API_KEY secret is valid" >> $GITHUB_STEP_SUMMARY
          echo "- Check API usage limits" >> $GITHUB_STEP_SUMMARY
          echo "- Test with manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
          echo "- Review recent code changes for syntax errors" >> $GITHUB_STEP_SUMMARY
