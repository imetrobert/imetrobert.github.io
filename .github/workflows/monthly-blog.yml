name: Generate Monthly AI Blog Post for Canadian Business

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: '0 9 1 * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      topic:
        description: 'Custom blog topic (optional - will use default Canadian business focus)'
        required: false
        type: string
      output:
        description: 'Output directory'
        required: false
        default: 'posts'
        type: choice
        options:
        - posts
        - staging

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Generate monthly AI insights blog post
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            python scripts/generate-blog.py --topic "${{ github.event.inputs.topic }}" --output ${{ github.event.inputs.output || 'posts' }}
          else
            python scripts/generate-blog.py --output ${{ github.event.inputs.output || 'posts' }}
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "AI Insights Generator"
      
      - name: Check for changes
        id: git-check
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          MONTH_YEAR=$(date +"%B %Y")
          git commit -m "🤖 Auto-generate AI Insights for Canadian Business - $MONTH_YEAR
          
          📊 Monthly AI developments analysis
          🇨🇦 Canadian business impact assessment  
          🎯 Strategic recommendations for digital leaders
          🔄 Homepage and blog index automatically updated
          
          Generated by: ${{ github.workflow }} #${{ github.run_number }}
          Template: AI insights format with citation cleaning
          Focus: Canadian market and regulatory considerations"
          
          git push
      
      - name: Create success summary
        if: steps.git-check.outputs.changes == 'true'
        run: |
          echo "## 🎉 AI Insights Blog Post Generated Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**📅 Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**🎯 Focus:** Canadian Business Impact" >> $GITHUB_STEP_SUMMARY
          echo "**📂 Output Directory:** ${{ github.event.inputs.output || 'posts' }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            echo "**🔖 Custom Topic:** ${{ github.event.inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Content Structure:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Key AI developments from the past month" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Canadian business impact analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Strategic recommendations for leaders" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Clean formatting (citations removed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔄 Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 New monthly blog post generated" >> $GITHUB_STEP_SUMMARY
          echo "- 🔗 \`blog/posts/latest.html\` updated" >> $GITHUB_STEP_SUMMARY
          echo "- 📋 \`blog/index.html\` updated with post listings" >> $GITHUB_STEP_SUMMARY
          echo "- 🏠 \`index.html\` homepage dynamically updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Check your website to verify the new post is live" >> $GITHUB_STEP_SUMMARY
          echo "- Review the generated content for quality and accuracy" >> $GITHUB_STEP_SUMMARY
          echo "- Share the insights on LinkedIn/social media" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor engagement and reader feedback" >> $GITHUB_STEP_SUMMARY
      
      - name: Create no-changes summary
        if: steps.git-check.outputs.changes == 'false'
        run: |
          echo "## ℹ️ No Changes Made" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The blog generation script ran but produced no changes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔍 Possible Reasons:" >> $GITHUB_STEP_SUMMARY
          echo "- 🔑 Perplexity API key issues or rate limiting" >> $GITHUB_STEP_SUMMARY
          echo "- 🌐 Network connectivity problems" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 Generated content identical to existing" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️ Script error or exception occurred" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🛠️ Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "- Check the workflow logs above for error messages" >> $GITHUB_STEP_SUMMARY
          echo "- Verify PERPLEXITY_API_KEY secret is properly set" >> $GITHUB_STEP_SUMMARY
          echo "- Try running the workflow manually to debug" >> $GITHUB_STEP_SUMMARY

  # Notify on failure for monitoring
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: generate-blog
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## ❌ Blog Generation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**📅 Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**🔧 Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**🔢 Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔍 Common Issues:" >> $GITHUB_STEP_SUMMARY
          echo "- 🔑 **API Key**: Perplexity API key invalid or expired" >> $GITHUB_STEP_SUMMARY
          echo "- 📊 **Rate Limits**: API usage limits exceeded" >> $GITHUB_STEP_SUMMARY
          echo "- 🌐 **Network**: Connectivity or timeout issues" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 **Dependencies**: Python packages missing/outdated" >> $GITHUB_STEP_SUMMARY
          echo "- 🔒 **Permissions**: Repository write access problems" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🛠️ Resolution Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Check Logs**: Review workflow logs for specific errors" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify Secrets**: Ensure PERPLEXITY_API_KEY is set correctly" >> $GITHUB_STEP_SUMMARY
          echo "3. **Manual Test**: Try running workflow manually with dispatch" >> $GITHUB_STEP_SUMMARY
          echo "4. **Script Check**: Review recent commits for breaking changes" >> $GITHUB_STEP_SUMMARY
          echo "5. **API Status**: Check Perplexity AI service status" >> $GITHUB_STEP_SUMMARY
