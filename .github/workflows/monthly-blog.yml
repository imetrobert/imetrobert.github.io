name: Generate Monthly AI Blog Post

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC (adjust timezone as needed)
    - cron: '0 9 1 * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      topic:
        description: 'Custom blog topic (optional)'
        required: false
        type: string
      output:
        description: 'Output directory'
        required: false
        default: 'posts'
        type: choice
        options:
        - posts
        - staging

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Generate blog post
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            python scripts/generate-blog.py --topic "${{ github.event.inputs.topic }}" --output ${{ github.event.inputs.output || 'posts' }}
          else
            python scripts/generate-blog.py --output ${{ github.event.inputs.output || 'posts' }}
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Monthly Blog Generator"
      
      - name: Check for changes
        id: git-check
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          MONTH_YEAR=$(date +"%B %Y")
          git commit -m "Auto-generate monthly AI insights blog post for $MONTH_YEAR
          
          - Generated new blog post with latest AI innovations
          - Updated blog index with featured post
          - Updated homepage preview
          - Maintained consistent formatting and styling
          
          Generated by: ${{ github.workflow }} #${{ github.run_number }}"
          
          git push
      
      - name: Create success summary
        if: steps.git-check.outputs.changes == 'true'
        run: |
          echo "## Blog Post Generated Successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Output Directory:** ${{ github.event.inputs.output || 'posts' }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            echo "**Custom Topic:** ${{ github.event.inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- New blog post generated and saved" >> $GITHUB_STEP_SUMMARY
          echo "- \`blog/posts/latest.html\` updated" >> $GITHUB_STEP_SUMMARY
          echo "- \`blog/index.html\` updated with new post data" >> $GITHUB_STEP_SUMMARY
          echo "- \`index.html\` homepage preview updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Check your website to verify the new post is live" >> $GITHUB_STEP_SUMMARY
          echo "- Review the generated content for quality" >> $GITHUB_STEP_SUMMARY
          echo "- Share the new post on social media if desired" >> $GITHUB_STEP_SUMMARY
      
      - name: Create no-changes summary
        if: steps.git-check.outputs.changes == 'false'
        run: |
          echo "## No Changes Made :information_source:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The blog generation script ran but produced no changes." >> $GITHUB_STEP_SUMMARY
          echo "This could mean:" >> $GITHUB_STEP_SUMMARY
          echo "- The script encountered an error" >> $GITHUB_STEP_SUMMARY
          echo "- No new content was generated" >> $GITHUB_STEP_SUMMARY
          echo "- Generated content was identical to existing content" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs above for more details." >> $GITHUB_STEP_SUMMARY

  # Optional: Send notification on failure
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: generate-blog
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## Blog Generation Failed :x:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Possible Issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Perplexity API key may be invalid or expired" >> $GITHUB_STEP_SUMMARY
          echo "- API rate limits may have been exceeded" >> $GITHUB_STEP_SUMMARY
          echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
          echo "- Python dependencies missing or outdated" >> $GITHUB_STEP_SUMMARY
          echo "- Repository permissions issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Check the workflow logs for specific error messages" >> $GITHUB_STEP_SUMMARY
          echo "- Verify PERPLEXITY_API_KEY secret is set correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Try running the workflow manually to test" >> $GITHUB_STEP_SUMMARY
          echo "- Check if there are any recent changes that might have broken the script" >> $GITHUB_STEP_SUMMARY
